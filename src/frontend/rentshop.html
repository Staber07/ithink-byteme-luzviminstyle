<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rent Item</title>
  <link rel="stylesheet" href="rentshop.css">
</head>
<body>
    <header class="header">
        <a href="#" class="logo">
          <img src="images/logo3.png" alt="LuzViMin logo" width="150px" height="auto" />
        </a>
        <nav class="navbar">
          <a href="shop.html" class="nav-link">Back to Shop</a>
        </nav>
    </header>

    <div class="rent-container">
        <h2 id="item-name">Item Name</h2>
        <p id="rent-price">Rent Price Per Hour: ₱0.00</p>
        
        <form id="rentForm">
          <div class="form-group">
            <label for="hours">Number of Hours:</label>
            <input type="number" id="hours" name="hours" min="1" required>
          </div>
          <button type="submit">Calculate Total Cost</button>
        </form>
        <p id="total-cost">Total Cost: ₱0.00</p>
        
        <!-- Check Out Button -->
        <button id="check-out" style="display: none;">Check Out</button>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Select Payment Method</h3>
            <div class="payment-options">
                <button id="gcash-button">Pay via GCash</button>
            </div>
            <!-- GCash Payment Details -->
            <div id="gcash-details" class="payment-details" style="display: none;">
                <h4>GCash QR Code</h4>
                <img src="images/qrimage.png" alt="GCash QR Code" width="200">
                <form id="gcash-form">
                    <p>Full Name of Sender:</p>
                    <input type="text" id="gcash-name" placeholder="Enter your full name" required>
                    <p>Amount:</p>
                    <input type="text" id="gcash-amount" placeholder="Enter the amount" readonly>
                    <p>Reference Number:</p>
                    <input type="text" id="gcash-reference" placeholder="Enter the reference number" required>
                    <button type="submit" id="submit-button">Submit</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Load Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js"></script>

    <!-- Your custom script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
        
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCQT-w4iKv3MuivCPdtB6LYHWlm9IucJKI",
          authDomain: "luzvimin-4a51e.firebaseapp.com",
          databaseURL: "https://luzvimin-4a51e-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "luzvimin-4a51e",
          storageBucket: "luzvimin-4a51e.appspot.com",
          messagingSenderId: "137799781399",
          appId: "1:137799781399:web:2010b8cafe6b06453ae052",
          measurementId: "G-MKJT7NXH71"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Function to get query parameters
        function getQueryParams() {
          const params = new URLSearchParams(window.location.search);
          return {
            name: params.get('name')
          };
        }
        
        async function getNextOrderId() {
          const idRef = ref(db, 'orderIdCounter');
          let nextId = 'RNT0001'; // Default starting ID

          try {
            const snapshot = await get(idRef);
            if (snapshot.exists()) {
              nextId = snapshot.val();
            }

            // Increment the ID
            const currentIdNumber = parseInt(nextId.replace('RNT', ''), 10);
            const newIdNumber = currentIdNumber + 1;
            nextId = 'RNT' + newIdNumber.toString().padStart(4, '0');

            // Update the counter in the database
            await set(idRef, nextId);
          } catch (error) {
            console.error('Error getting or updating order ID:', error);
          }

          return nextId;
        }
        
        window.onload = function() {
          const params = getQueryParams();
          const itemNameElement = document.getElementById('item-name');
          const rentPriceElement = document.getElementById('rent-price');
          const itemName = params.name;

          if (itemName) {
            const itemRef = ref(db, 'items/' + itemName);
            get(itemRef).then((snapshot) => {
              if (snapshot.exists()) {
                const itemData = snapshot.val();
                itemNameElement.textContent = itemName;
                const rentPrice = parseFloat(itemData.rentPrice);
                rentPriceElement.textContent = isNaN(rentPrice) ? 'Rent Price Per Hour: ₱0.00' : `Rent Price Per Hour: ₱${rentPrice.toFixed(2)}`;
              } else {
                itemNameElement.textContent = 'Item not found';
                rentPriceElement.textContent = 'Rent Price Per Hour: ₱0.00';
              }
            }).catch((error) => {
              console.error('Error fetching data:', error);
            });
          }
        };
      
        // Handle rent form submission
        document.getElementById('rentForm').addEventListener('submit', function(event) {
          event.preventDefault();
          
          const hours = document.getElementById('hours').value;
          const itemName = getQueryParams().name;
          
          if (itemName) {
            const itemRef = ref(db, 'items/' + itemName);
            get(itemRef).then((snapshot) => {
              if (snapshot.exists()) {
                const itemData = snapshot.val();
                const rentPricePerHour = parseFloat(itemData.rentPrice);
                const totalCost = isNaN(rentPricePerHour) ? 0 : rentPricePerHour * hours;
                document.getElementById('total-cost').textContent = `Total Cost: ₱${totalCost.toFixed(2)}`;
                document.getElementById('total-cost').style.display = 'block'; // Show total cost
                document.getElementById('check-out').style.display = 'block';
              }
            }).catch((error) => {
              console.error('Error fetching data:', error);
            });
          }
        });
      
        // Modal handling
        const modal = document.getElementById('payment-modal');
        const checkOutButton = document.getElementById('check-out');
        const closeModal = document.querySelector('.modal .close');
        
        checkOutButton.addEventListener('click', () => {
          const totalCost = document.getElementById('total-cost').textContent.replace('Total Cost: ₱', '');
          document.getElementById('gcash-amount').value = totalCost; // Set total cost in the GCash form
          modal.style.display = 'block';
        });
        
        closeModal.addEventListener('click', () => {
          modal.style.display = 'none';
        });
      
        document.getElementById('gcash-button').addEventListener('click', () => {
          document.getElementById('gcash-details').style.display = 'block';
        });
      
        // Handle GCash form submission
        document.getElementById('gcash-form').addEventListener('submit', async function(event) {
          event.preventDefault();
          
          const senderName = document.getElementById('gcash-name').value;
          const referenceNumber = document.getElementById('gcash-reference').value;
          const amount = document.getElementById('gcash-amount').value;
          const username = localStorage.getItem('loggedInUser'); // Get username from localStorage

          // Generate a new order ID
          const orderId = await getNextOrderId();

          const orderData = {
            itemName: getQueryParams().name,
            rentPricePerHour: parseFloat(document.getElementById('rent-price').textContent.replace('Rent Price Per Hour: ₱', '')),
            hours: document.getElementById('hours').value,
            totalCost: amount,
            paymentMode: 'GCash',
            senderName: senderName,
            referenceNumber: referenceNumber,
            timestamp: new Date().toISOString(),
            orderId: orderId
          };

          // Add order to Firebase under the username node
          const ordersRef = ref(db, `rentorders/${username}/${orderId}`);

          set(ordersRef, orderData).then(() => {
            alert('Order placed successfully!');
            // Redirect to shop.html after alert
           window.location.href = 'userorder.html';
          }).catch((error) => {
            console.error('Error placing order:', error);
          });
        });
    </script>
    
</body>
</html>
